# Cross-platform Makefile for Ultimata Server
# Use: make          (for release build)
#      make debug     (for debug build)  
#      make clean     (to clean build files)
#
# NOTE: For modern development on Windows, use vcpkg and CMake:
#   1. Run setup-vcpkg.bat to install dependencies and build
#   2. Run start-server.bat to start the server
#
# For Linux/macOS, you can use this Makefile or CMake

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -pthread
INCLUDES = -Isrc

# Platform detection
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    PLATFORM = linux
    LIBS = -lboost_system -lSDL2 -lSDL2_net -lpthread
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM = macos  
    LIBS = -lboost_system -lSDL2 -lSDL2_net -lpthread
    # macOS might need different library paths
    INCLUDES += -I/usr/local/include -I/opt/homebrew/include
    LDFLAGS += -L/usr/local/lib -L/opt/homebrew/lib
endif

# Build configuration
BUILD_DIR = build
TARGET = $(BUILD_DIR)/ultimata-server
SOURCES = src/Main.cpp \
          src/SDLNetManager.cpp \
          src/Connection.cpp \
          src/ConnectionManager.cpp \
          src/AsioConnection.cpp \
          src/AsioConnectionManager.cpp \
          src/AsioNetworkManager.cpp \
          src/NetworkConfig.cpp

OBJECTS = $(SOURCES:src/%.cpp=$(BUILD_DIR)/%.o)

# Default target
all: release

# Release build
release: CXXFLAGS += -O3 -DNDEBUG
release: $(TARGET)

# Debug build  
debug: CXXFLAGS += -g -O0 -DDEBUG
debug: $(TARGET)

# Link target
$(TARGET): $(OBJECTS) | $(BUILD_DIR)
	@echo "Linking $(TARGET)..."
	$(CXX) $(OBJECTS) -o $@ $(LDFLAGS) $(LIBS)
	@echo "Build complete: $(TARGET)"

# Compile source files
$(BUILD_DIR)/%.o: src/%.cpp | $(BUILD_DIR)
	@echo "Compiling $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Clean build files
clean:
	@echo "Cleaning build files..."
	rm -rf $(BUILD_DIR)

# Install dependencies (Ubuntu/Debian)
install-deps-ubuntu:
	sudo apt-get update
	sudo apt-get install -y build-essential cmake libboost-all-dev libsdl2-dev libsdl2-net-dev

# Install dependencies (macOS with Homebrew)
install-deps-macos:
	brew install boost sdl2 sdl2_net cmake

# Show help
help:
	@echo "Available targets:"
	@echo "  all (default)     - Build release version"
	@echo "  release           - Build optimized release version"
	@echo "  debug             - Build debug version with symbols"
	@echo "  clean             - Remove all build files"
	@echo "  install-deps-ubuntu - Install dependencies on Ubuntu/Debian"
	@echo "  install-deps-macos  - Install dependencies on macOS"
	@echo "  help              - Show this help message"

.PHONY: all release debug clean install-deps-ubuntu install-deps-macos help